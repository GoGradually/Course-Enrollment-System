# k6 실행 가이드

## 1. 사전 조건

- JDK 21
- `k6`
- `curl`

## 2. 기본 원칙

- 시나리오는 **한 번에 하나씩** 실행한다.
- 서버는 원하는 격리수준 프로파일로 먼저 기동한다.
- 결과 요약은 `SUMMARY_PATH`로 시나리오별 파일을 분리 저장한다.

## 3. 서버 실행

READ COMMITTED:

```bash
SPRING_PROFILES_ACTIVE=read-committed ./gradlew bootRun
```

REPEATABLE READ:

```bash
SPRING_PROFILES_ACTIVE=repeatable-read ./gradlew bootRun
```

## 4. 실행 환경

디스크 I/O 기준으로 판단하기 위해, docker mysql 이미지 사용

```bash
docker run -d --name mysql-test \
  -e MYSQL_ROOT_PASSWORD=pass \
  -p 3307:3306 \
  mysql:8
```

## 5. 시나리오 파일

- `performance/k6/scenarios/rc-pessimistic.js`
- `performance/k6/scenarios/rc-optimistic.js`
- `performance/k6/scenarios/rc-atomic.js`
- `performance/k6/scenarios/rc-separated.js`
- `performance/k6/scenarios/rr-pessimistic.js`
- `performance/k6/scenarios/rr-optimistic.js`
- `performance/k6/scenarios/rr-atomic.js`
- `performance/k6/scenarios/rr-separated.js`

## 6. 단일 시나리오 실행 예시

```bash
BASE_URL=http://localhost:8080 \
VUS=1000 \
LOOPS=1 \
RAMP_UP_SECONDS=5 \
P95_MS=1000 \
FAIL_ON_ASSERTION=true \
SUMMARY_PATH=performance/k6/results/rc-atomic.summary.json \
k6 run performance/k6/scenarios/rc-atomic.js
```

```bash
BASE_URL=http://localhost:8080 \
VUS=1000 \
LOOPS=1 \
RAMP_UP_SECONDS=5 \
P95_MS=1000 \
FAIL_ON_ASSERTION=true \
SUMMARY_PATH=performance/k6/results/rr-optimistic.summary.json \
k6 run performance/k6/scenarios/rr-optimistic.js
```

## 7. 런타임 데이터 준비 규칙

- `HOT_COURSE_ID` 미지정 시 `TARGET_CAPACITY`(기본 100), `enrolled=0` 조건의 강좌를 자동 선택
- `HOT_COURSE_ID` 지정 시 해당 강좌 ID를 우선 사용
- 필요한 학생 수(`VUS * LOOPS`)만큼 `/students`에서 고유 ID 수집

## 8. 환경 변수

- `BASE_URL` (기본: `http://localhost:8080`)
- `VUS` (기본: `1000`)
- `LOOPS` (기본: `1`)
- `RAMP_UP_SECONDS` (기본: `5`)
- `P95_MS` (기본: `1000`)
- `MAX_DURATION` (기본: `2m`)
- `FAIL_ON_ASSERTION` (기본: `false`, `true`면 teardown 도메인 불변식 위반 시 임계치 실패)
- `HOT_COURSE_ID` (선택)
- `TARGET_CAPACITY` (기본: `100`, `HOT_COURSE_ID` 미지정 시 사용)
- `SUMMARY_PATH` (기본: `performance/k6/results/<scenario>.summary.json`)
- `K6_SUMMARY_TREND_STATS` (선택, 기본: `avg,min,med,max,p(90),p(95),p(99)`)

## 9. 핵심 지표

- 성공률: `201 / total`
- 충돌률: `409 / total`
- 규칙위반률: `422 / total`
- 지연시간: avg/med/max/p95/p99
- Throughput(req/s)
- `summary.json`의 각 필드 정의/계산식은 `11. Result(JSON) 필드 설명`을 기준으로 해석한다.

## 10. Pass/Fail 기준

- `201/409/422` 이외의 코드가 있으면 실패(`enroll_status_unexpected > 0`)
- 총 요청 수가 `VUS * LOOPS`와 다르면 실패
- 지연시간 p95가 `P95_MS` 초과면 실패
- `FAIL_ON_ASSERTION=true`일 때 teardown에서 `enrolled <= capacity` 위반 시 실패
- 따라서 핫코스에서 `201=100`, `422=900`처럼 정원 기반으로 귀결된 결과는 **정상 통과 가능**하다.

## 11. Result(JSON) 필드 설명

`SUMMARY_PATH`에 저장되는 `*.summary.json` 구조는 아래와 같다.

```json
{
  "scenario": "rc-atomic",
  "course": {
    "id": 6,
    "capacity": 100,
    "enrolledFinal": 100
  },
  "totals": {
    "total": 1000,
    "attempts": 1000,
    "expectedAttempts": 1000,
    "status201": 100,
    "status409": 0,
    "status422": 900,
    "unexpected": 0
  },
  "ratios": {
    "successRate": 0.1,
    "conflictRate": 0,
    "ruleViolationRate": 0.9
  },
  "latencyMs": {
    "avg": 189.91730068879932,
    "med": 2.4582545,
    "max": 1098.069163,
    "p95": 863.7992618000001,
    "p99": 1042.7753821
  },
  "throughputRps": 741.2552523807226,
  "domainAssertions": {
    "allowedCodesOnly": true,
    "noUnexpectedStatus": true,
    "requestCountMatched": true,
    "capacityNotExceeded": true,
    "pass": true
  }
}
```

계산 로직 기준 파일:

- `performance/k6/lib/summary.js`
- `performance/k6/lib/config.js`

| 필드                                     | 의미                | 계산/기준                                                                                  | 해석 팁                           |
|----------------------------------------|-------------------|----------------------------------------------------------------------------------------|--------------------------------|
| `scenario`                             | 실행한 시나리오 이름       | 각 시나리오 스크립트의 `SCENARIO_NAME` 값                                                         | 결과 파일과 실행 스크립트 매핑 키로 사용        |
| `course.id`                            | 테스트 대상 강좌 ID      | `hot_course_id` Gauge                                                                  | `HOT_COURSE_ID` 지정/자동선정 결과 확인용 |
| `course.capacity`                      | 대상 강좌 정원          | `hot_course_capacity` Gauge                                                            | `status201`의 상한 해석 기준          |
| `course.enrolledFinal`                 | 테스트 종료 시 실제 수강 인원 | teardown에서 조회한 `hot_course_enrolled_final` Gauge                                       | 최종 상태가 정원을 넘지 않았는지 확인          |
| `totals.total`                         | 상태 코드 기준 총 응답 수   | `status201 + status409 + status422 + unexpected`                                       | 일반적으로 `attempts`와 같아야 정상       |
| `totals.attempts`                      | 실제 시도 요청 수        | `enroll_attempts` Counter `count`                                                      | VU 반복 실행이 실제로 수행된 횟수           |
| `totals.expectedAttempts`              | 기대 요청 수           | `VUS * LOOPS`                                                                          | 부하 프로파일 대비 실행량 기준값             |
| `totals.status201`                     | 성공(등록 완료) 건수      | `enroll_status_201` Counter `count`                                                    | 정원 경쟁 시 정원 근처 값으로 수렴           |
| `totals.status409`                     | 충돌(중복/경합) 건수      | `enroll_status_409` Counter `count`                                                    | `0`이어도 실패 아님                   |
| `totals.status422`                     | 규칙 위반(정원 초과 등) 건수 | `enroll_status_422` Counter `count`                                                    | 경쟁 강도가 높을수록 증가 가능              |
| `totals.unexpected`                    | 비허용 코드 건수         | `enroll_status_unexpected` Counter `count`                                             | `0`이 아니면 실패 원인                 |
| `ratios.successRate`                   | 성공률               | `status201 / total`                                                                    | `total <= 0`이면 `0`             |
| `ratios.conflictRate`                  | 충돌률               | `status409 / total`                                                                    | `total <= 0`이면 `0`             |
| `ratios.ruleViolationRate`             | 규칙위반률             | `status422 / total`                                                                    | `total <= 0`이면 `0`             |
| `latencyMs.avg`                        | 평균 지연시간(ms)       | `enroll_latency_ms.values.avg`                                                         | 전체 응답 체감 평균                    |
| `latencyMs.med`                        | 중앙값 지연시간(ms)      | `enroll_latency_ms.values.med`                                                         | 이상치 영향이 평균보다 적음                |
| `latencyMs.max`                        | 최대 지연시간(ms)       | `enroll_latency_ms.values.max`                                                         | 최악 응답 확인                       |
| `latencyMs.p95`                        | p95 지연시간(ms)      | `enroll_latency_ms.values['p(95)']`                                                    | `P95_MS` 임계치 판정 기준             |
| `latencyMs.p99`                        | p99 지연시간(ms)      | `enroll_latency_ms.values['p(99)']`                                                    | tail latency 확인 지표             |
| `throughputRps`                        | 초당 처리 요청 수(req/s) | `enroll_attempts.values.rate`                                                          | 시나리오별 처리량 비교 지표                |
| `domainAssertions.allowedCodesOnly`    | 허용 코드만 반환되었는지     | `enroll_allowed_code_rate == 1`                                                        | 허용 코드 집합: `201/409/422`        |
| `domainAssertions.noUnexpectedStatus`  | 비허용 코드가 없는지       | `totals.unexpected == 0`                                                               | `false`면 즉시 실패로 해석             |
| `domainAssertions.requestCountMatched` | 요청 수 일치 여부        | `attempts == expectedAttempts`                                                         | 누락/중단 실행 탐지                    |
| `domainAssertions.capacityNotExceeded` | 정원 초과 방지 충족 여부    | `status201 <= capacity` AND (지표 존재 시 `domain_capacity_not_exceeded == 1`)              | 상태코드와 최종 DB 상태를 함께 검증          |
| `domainAssertions.pass`                | 종합 도메인 판정         | `allowedCodesOnly && noUnexpectedStatus && requestCountMatched && capacityNotExceeded` | 최종 해석은 `pass`를 우선 확인           |

해석 시 주의사항:

- `totals.status422`가 높아도 `domainAssertions.pass=true`이면 정원 경쟁 상황에서 정상 결과일 수 있다.
- `totals.status409=0`은 실패 조건이 아니다(허용 코드 집합 내 정상 케이스).
