# k6 실행 가이드

## 1. 사전 조건

- JDK 21
- `k6`
- `curl`

## 2. 기본 원칙

- 시나리오는 **한 번에 하나씩** 실행한다.
- 서버는 원하는 격리수준 프로파일로 먼저 기동한다.
- 결과 요약은 `SUMMARY_PATH`로 시나리오별 파일을 분리 저장한다.

## 3. 서버 실행

READ COMMITTED:

```bash
SPRING_PROFILES_ACTIVE=read-committed ./gradlew bootRun
```

REPEATABLE READ:

```bash
SPRING_PROFILES_ACTIVE=repeatable-read ./gradlew bootRun
```

## 4. 실행 환경

디스크 I/O 기준으로 판단하기 위해, docker mysql 이미지 사용

```bash
docker run -d --name mysql-test \
  -e MYSQL_ROOT_PASSWORD=pass \
  -p 3307:3306 \
  mysql:8
```

## 5. 시나리오 파일

- `performance/k6/scenarios/rc-pessimistic.js`
- `performance/k6/scenarios/rc-optimistic.js`
- `performance/k6/scenarios/rc-atomic.js`
- `performance/k6/scenarios/rc-separated.js`
- `performance/k6/scenarios/rr-pessimistic.js`
- `performance/k6/scenarios/rr-optimistic.js`
- `performance/k6/scenarios/rr-atomic.js`
- `performance/k6/scenarios/rr-separated.js`

## 6. 단일 시나리오 실행 예시

```bash
BASE_URL=http://localhost:8080 \
VUS=200 \
LOOPS=1 \
RAMP_UP_SECONDS=5 \
P95_MS=1000 \
FAIL_ON_ASSERTION=true \
SUMMARY_PATH=performance/k6/results/rc-atomic.summary.json \
k6 run performance/k6/scenarios/rc-atomic.js
```

```bash
BASE_URL=http://localhost:8080 \
VUS=200 \
LOOPS=1 \
RAMP_UP_SECONDS=5 \
P95_MS=1000 \
FAIL_ON_ASSERTION=true \
SUMMARY_PATH=performance/k6/results/rr-optimistic.summary.json \
k6 run performance/k6/scenarios/rr-optimistic.js
```

## 7. 런타임 데이터 준비 규칙

- `HOT_COURSE_ID` 미지정 시 `/courses` 조회 결과에서 자동 선택
- `HOT_COURSE_ID` 지정 시 해당 강좌 ID를 우선 사용
- 필요한 학생 수(`VUS * LOOPS`)만큼 `/students`에서 고유 ID 수집

## 8. 환경 변수

- `BASE_URL` (기본: `http://localhost:8080`)
- `VUS` (기본: `5000`)
- `LOOPS` (기본: `1`)
- `RAMP_UP_SECONDS` (기본: `5`)
- `P95_MS` (기본: `1000`)
- `MAX_DURATION` (기본: `2m`)
- `FAIL_ON_ASSERTION` (기본: `false`, `true`면 teardown 도메인 불변식 위반 시 임계치 실패)
- `HOT_COURSE_ID` (선택)
- `SUMMARY_PATH` (기본: `performance/k6/results/<scenario>.summary.json`)

## 9. 핵심 지표

- 성공률: `201 / total`
- 충돌률: `409 / total`
- 규칙위반률: `422 / total`
- 지연시간: avg/med/max/p95/p99
- Throughput(req/s)

## 10. Pass/Fail 기준

- `201/409/422` 이외의 코드가 있으면 실패(`enroll_status_unexpected > 0`)
- 총 요청 수가 `VUS * LOOPS`와 다르면 실패
- 지연시간 p95가 `P95_MS` 초과면 실패
- `FAIL_ON_ASSERTION=true`일 때 teardown에서 `enrolled <= capacity` 위반 시 실패
- 따라서 핫코스에서 `201=60`, `422=140`처럼 정원 기반으로 귀결된 결과는 **정상 통과 가능**하다.
