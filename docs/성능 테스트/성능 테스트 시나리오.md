# 성능 테스트 시나리오

## 1. 전략/격리수준 조합

단일 핫코스 시나리오:

- REPEATABLE_READ + 비관적 락
- REPEATABLE_READ + 낙관적 락
- REPEATABLE_READ + SQL 직접 사용(atomic)
- REPEATABLE_READ + 트랜잭션 분리(separated)
- READ_COMMITTED + 비관적 락
- READ_COMMITTED + 낙관적 락
- READ_COMMITTED + SQL 직접 사용(atomic)
- READ_COMMITTED + 트랜잭션 분리(separated)

이번 확장 비교의 핵심 대상:

- `READ_COMMITTED`: `SQL 직접 사용(atomic)` vs `트랜잭션 분리(separated)`
- `REPEATABLE_READ`: `SQL 직접 사용(atomic)` vs `트랜잭션 분리(separated)`

## 2. 주요 지표

- 성공률: `201 / total`
- 충돌률: `409 / total`
- 규칙위반률: `422 / total`
- 지연시간: avg/med/max/p95/p99
- Throughput(req/s)
- 도메인 불변식 통과 여부(`domainAssertions.pass`)

## 3. 멀티코스 경쟁 프로파일

- 대상 과목 수: `50`
- 경쟁 배수: `capacity * 3`
- 요청 분포: 전 과목 랜덤 인터리브(시드 기반 셔플)
- 학생 할당: 요청 1건당 고유 학생 1명
- 스레드/동시성: `VUS=1000`
- Ramp-up: `5s`
- 최대 iteration 설정: `MULTI_MAX_TOTAL_ATTEMPTS=10000`
- 실제 요청 수: `sum(selectedCourse.capacity * 3)` (`plannedAttempts`)

## 4. 선택/검증 규칙

- 기본적으로 `enrolled=0`인 강좌만 후보로 사용
- 후보를 ID 오름차순으로 50개 선택
- `plannedAttempts > MULTI_MAX_TOTAL_ATTEMPTS`이면 setup에서 실패
- teardown에서 선택된 모든 과목의 `enrolled <= capacity`를 검증

## 5. k6 시나리오 파일 매핑

단일 핫코스:

- `performance/k6/scenarios/rc-pessimistic.js`
- `performance/k6/scenarios/rc-optimistic.js`
- `performance/k6/scenarios/rc-atomic.js` (`/enrollments/atomic`, SQL 직접 사용)
- `performance/k6/scenarios/rc-separated.js` (`/enrollments/separated`, 트랜잭션 분리)
- `performance/k6/scenarios/rr-pessimistic.js`
- `performance/k6/scenarios/rr-optimistic.js`
- `performance/k6/scenarios/rr-atomic.js` (`/enrollments/atomic`, SQL 직접 사용)
- `performance/k6/scenarios/rr-separated.js` (`/enrollments/separated`, 트랜잭션 분리)

멀티코스(SQL 직접 사용(atomic) vs 트랜잭션 분리(separated) 비교용):

- `performance/k6/scenarios/rc-atomic-multi.js` (`/enrollments/atomic`, SQL 직접 사용)
- `performance/k6/scenarios/rc-separated-multi.js` (`/enrollments/separated`, 트랜잭션 분리)
- `performance/k6/scenarios/rr-atomic-multi.js` (`/enrollments/atomic`, SQL 직접 사용)
- `performance/k6/scenarios/rr-separated-multi.js` (`/enrollments/separated`, 트랜잭션 분리)

## 6. 실행 방식

- 한 번에 하나의 시나리오만 실행한다.
- 공정 비교를 위해 SQL 직접 사용(atomic) 실행과 트랜잭션 분리(separated) 실행 사이에 서버를 재기동한다.
- RC/RR 각각 독립적으로 동일 절차를 반복한다.

실행 템플릿:

```bash
BASE_URL=http://localhost:8080 \
VUS=1000 \
RAMP_UP_SECONDS=5 \
P95_MS=1000 \
FAIL_ON_ASSERTION=true \
MULTI_COURSE_COUNT=50 \
MULTI_COMPETITION_MULTIPLIER=3 \
MULTI_MAX_TOTAL_ATTEMPTS=10000 \
MULTI_INTERLEAVE_SEED=20260222 \
MULTI_REQUIRE_EMPTY_ENROLLED=true \
SUMMARY_PATH=performance/k6/results/<scenario>.summary.json \
k6 run performance/k6/scenarios/<scenario>.js
```

## 7. 비교 절차

READ_COMMITTED:

1. `SPRING_PROFILES_ACTIVE=read-committed ./gradlew bootRun`
2. `rc-atomic-multi` 실행 (SQL 직접 사용, `/enrollments/atomic`)
3. 서버 재기동(`read-committed`)
4. `rc-separated-multi` 실행 (트랜잭션 분리, `/enrollments/separated`)
5. `scripts/compare-k6-summary.sh`로 결과 비교

REPEATABLE_READ:

1. `SPRING_PROFILES_ACTIVE=repeatable-read ./gradlew bootRun`
2. `rr-atomic-multi` 실행 (SQL 직접 사용, `/enrollments/atomic`)
3. 서버 재기동(`repeatable-read`)
4. `rr-separated-multi` 실행 (트랜잭션 분리, `/enrollments/separated`)
5. `scripts/compare-k6-summary.sh`로 결과 비교

## 8. 판정 기준

- 허용 코드(`201/409/422`) 외 응답이 없어야 한다.
- `totals.attempts`는 `workload.plannedAttempts`와 일치해야 한다.
- 선택된 모든 과목에서 최종 `enrolled <= capacity`를 만족해야 한다.
- 지연시간 p95는 `P95_MS` 이하이어야 한다.

참고:

- 경쟁 강도가 높으면 `422` 비율이 높아질 수 있으며, 이는 불합격 조건이 아니다.
- `409=0` 역시 허용 가능한 결과다.
