성능 테스트 시나리오를 리스트업 해보자.

- REPEATABLE_READ + 비관적 락(Locking Read)
- REPEATABLE_READ + 낙관적 락
- REPEATABLE_READ + SQL 직접 사용(SQL 자체 Lock 사용)
- REPEATABLE_READ + 트랜잭션 분리

- READ_COMMITTED + 비관적 락(Locking Read)
- READ_COMMITTED + 낙관적 락
- READ_COMMITTED + SQL 직접 사용(SQL 자체 Lock 사용)
- READ_COMMITTED + 트랜잭션 분리


### 주요 지표
- 성공률: `201 / total`
- 충돌률: `409 / total`
- 규칙위반률: `422 / total`
- 평균/중앙값/최대 지연시간
- p95, p99
- Throughput(req/s)


### 공통 설정(전략 비교를 위해 동일 부하 프로파일 사용)

- Threads: `1000`
- Ramp-up: `5s` (동시성 집중)
- Loop: `1` (동시 순간 요청)
- courseId: 기본 `TARGET_CAPACITY=100` 강좌 자동 선택(필요 시 `HOT_COURSE_ID`로 고정)
- studentId: `/students` 조회로 확보한 고유 ID 사용(중복 409를 “중복신청”이 아닌 “동시성/정원”에 가깝게 만들기 위함)

### Thread Group: `TG_HotCourse_Base`
- Sampler: `POST /enrollments` with body:

```json
{"studentId": ${studentId}, "courseId": ${HOT_COURSE_ID}}
```
### Thread Group: `TG_HotCourse_Pessimistic`

- Sampler: `POST /enrollments/pessimistic`
### Thread Group: `TG_HotCourse_Optimistic`
- Sampler: `POST /enrollments/optimistic`

### Thread Group: `TG_HotCourse_Atomic`
- Sampler: `POST /enrollments/atomic`

### Assertions (핫 강좌에서는 허용 코드 범위를 넓게)

- Response Code가 `201` 또는 `409` 또는 `422` 인지 검사
    - JMeter 기본 Assertion만으로 다중 코드 허용이 불편하면 **JSR223 Assertion(Groovy)**로 처리:
        - 허용 코드 집합: `{201, 409, 422}`
- 최종 상태 검증: 테스트 종료 시 `enrolled <= capacity` 유지

### 수집 지표(필수)

- 코드별 건수: `201/409/422` 각각 몇 건인지
- Throughput (req/s)
- Latency 분포: p90/p95/p99 (JMeter 리스너 + Backend Listener/InfluxDB+Grafana 등 선택)


정원(capacity)이 `C`라면, **이상적 결과**는 `201 <= C` 이고 나머지는 `422` 또는 `409`로 귀결될 것이다.

### k6 시나리오 파일 매핑

- `performance/k6/scenarios/rc-pessimistic.js`
- `performance/k6/scenarios/rc-optimistic.js`
- `performance/k6/scenarios/rc-atomic.js`
- `performance/k6/scenarios/rc-separated.js`
- `performance/k6/scenarios/rr-pessimistic.js`
- `performance/k6/scenarios/rr-optimistic.js`
- `performance/k6/scenarios/rr-atomic.js`
- `performance/k6/scenarios/rr-separated.js`

### 실행 방식

- 한 번에 하나의 시나리오만 실행한다.
- 서버는 실행 전에 격리수준 프로파일(`read-committed` 또는 `repeatable-read`)로 기동한다.
- `HOT_COURSE_ID`를 지정하지 않으면 `TARGET_CAPACITY=100`, `enrolled=0` 조건 강좌를 자동 선택한다.
- `studentId`는 `/students` 조회로 수집한 고유 ID를 사용한다.

시나리오별 실행 템플릿:

```bash
BASE_URL=http://localhost:8080 \
VUS=1000 \
LOOPS=1 \
RAMP_UP_SECONDS=5 \
P95_MS=1000 \
FAIL_ON_ASSERTION=true \
TARGET_CAPACITY=100 \
SUMMARY_PATH=performance/k6/results/<scenario>.summary.json \
k6 run performance/k6/scenarios/<scenario>.js
```

### 판정 기준

- 허용 코드(`201/409/422`) 외 응답이 없어야 한다.
- 총 요청 수는 `VUS * LOOPS`와 일치해야 한다.
- `201`은 정원(`capacity`)을 넘으면 안 된다.
- `FAIL_ON_ASSERTION=true`일 때 teardown에서 실제 최종 `enrolled <= capacity`를 재검증한다.
- 따라서 `201=100`, `422=900`은 정원 100 강좌 경쟁 상황에서 정상 결과가 될 수 있다.
